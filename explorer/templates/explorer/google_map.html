{% load staticfiles %}
<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="{% static 'explorer/main.css' %}" />
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script>

var map;
var geojsonData;
var ne_lat = 0.0, ne_lng = 0.0, sw_lat = 0.0, sw_lng = 0.0;
var infowindow;
var selected_provider = 0

function fill_in_provider_data(jsonData){
  procedures = jsonData['procedures'];
  box = document.getElementById('provider_data');
  while (box.firstChild) {
    box.removeChild(box.firstChild);
  }
  
  box.innerHTML = "";
  
  table = document.createElement('table');
  box.appendChild(table);
  
  for(i = 0; i < procedures.length; i++){
    row = document.createElement('tr');
    table.appendChild(row);
    item = document.createElement('td');
    row.appendChild(item);
    text = document.createTextNode(procedures[i][0]);
    item.appendChild(text);
    item = document.createElement('td');
    row.appendChild(item);
    text = document.createTextNode(procedures[i][1]);
    item.appendChild(text);
  }
}

function on_server_response(xmlhttp){
  if (xmlhttp.readyState==4 && xmlhttp.status==200) {
    jsonData = JSON.parse(xmlhttp.responseText);
    if(jsonData['type'] == 'FeatureCollection') {
      map.data.forEach(function(feature){map.data.remove(feature);});
      map.data.addGeoJson(jsonData);
    }
    else if(jsonData['type'] = 'ProviderData'){
      fill_in_provider_data(jsonData);
    }
  }
}

function request_map_data(){
  if (window.XMLHttpRequest) {
    // code for IE7+, Firefox, Chrome, Opera, Safari
    xmlhttp=new XMLHttpRequest();
  } else {  // code for IE6, IE5
    xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
  }
  xmlhttp.onreadystatechange=function() {on_server_response(xmlhttp);};
  xmlhttp.open(
    "GET", 
    "map_data?ne_lat=" + String(ne_lat) + 
    "&ne_lng=" + String(ne_lng) +
    "&sw_lat=" + String(sw_lat) +
    "&sw_lng=" + String(sw_lng),
    true);
  xmlhttp.send();
}

function request_provider_data(){
  if (selected_provider == 0)
    return;
    
  if (window.XMLHttpRequest) {
    // code for IE7+, Firefox, Chrome, Opera, Safari
    xmlhttp=new XMLHttpRequest();
  } else {  // code for IE6, IE5
    xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
  }
  xmlhttp.onreadystatechange=function() {on_server_response(xmlhttp);};
  xmlhttp.open(
    "GET", 
    "provider_data?npi=" + String(selected_provider),
    true);
  xmlhttp.send();
}


function on_bounds_changed(){
  
  ne_lat_1 = map.getBounds().getNorthEast().lat(),
  ne_lng_1 = map.getBounds().getNorthEast().lng(),
  sw_lat_1 = map.getBounds().getSouthWest().lat(),
  sw_lng_1= map.getBounds().getSouthWest().lng();
  
  span_lat_1 = ne_lat_1 - sw_lat_1;
  span_lng_1 = ne_lng_1 - sw_lng_1;
  span_lat = ne_lat - sw_lat;
  span_lng = ne_lng - sw_lng;  
  
  // Only reload the data if the view changes a lot
  if(
    ne_lat_1 > ne_lat || 
    ne_lng_1 > ne_lng || 
    sw_lat_1 < sw_lat ||
    sw_lng_1 < sw_lng ||
    span_lat_1 < 0.20 * span_lat||
    span_lng_1 < 0.20 * span_lng
    )
  {
    
    ne_lat = ne_lat_1 + span_lat_1;
    sw_lat = sw_lat_1 - span_lat_1;
      
    ne_lng = ne_lng_1 + span_lng_1;
    sw_lng = sw_lng_1 - span_lng_1;
    request_map_data();  
  }
}

function initialize() {
  var mapCanvas = document.getElementById('map-canvas');
  var mapOptions = {
    center: new google.maps.LatLng(42.37, -71.12),
    zoom: 8,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  }
  map = new google.maps.Map(mapCanvas, mapOptions);
  infowindow = new google.maps.InfoWindow();
  
  map.data.setStyle(function(feature) {
    var radius = 5 * feature.getProperty('expensiveness');
    return {
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        strokeWeight: 1,
        fillOpacity: .5,
        fillColor: '#CC0066',
        strokeColor: '#660033',
        scale: radius
      }
    };
  });
  
  google.maps.event.addListener(map, 'bounds_changed', on_bounds_changed);
  map.data.addListener('mouseover', function(event) {
    infowindow.setContent(
      event.feature.getProperty('first_name') + " " + 
      event.feature.getProperty('last_name') + "<br/>" +
      event.feature.getProperty('npi'));
    infowindow.setPosition(event.latLng);
    infowindow.setOptions({pixelOffset: new google.maps.Size(0,-34)});
    infowindow.open(map);
  });
  
  map.data.addListener('click', function(event) {
    selected_provider = event.feature.getProperty('npi');
    request_provider_data()
  });
  
}

google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
<body>

<h1>My First Heading</h1>

<p>My first paragraph.</p>
<div id = provider_data> </div>
<div id="map-canvas" style="width:50em;height:40em;"></div>
</body>
</html>
