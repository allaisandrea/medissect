<!DOCTYPE html>
<html>
  <head>
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script>

var map;
var geoJsonData;
var ne_lat = 0.0, ne_lng = 0.0, sw_lat = 0.0, sw_lng = 0.0;



function on_server_response(xmlhttp){
  if (xmlhttp.readyState==4 && xmlhttp.status==200) {
    geoJsonData = JSON.parse(xmlhttp.responseText);
    map.data.forEach(function(feature){map.data.remove(feature);});
    map.data.addGeoJson(geoJsonData);
//     document.getElementById('c2').innerHTML = xmlhttp.responseText;
  }
}

function request_data(){
  if (window.XMLHttpRequest) {
    // code for IE7+, Firefox, Chrome, Opera, Safari
    xmlhttp=new XMLHttpRequest();
  } else {  // code for IE6, IE5
    xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
  }
  xmlhttp.onreadystatechange=function() {on_server_response(xmlhttp);};
  xmlhttp.open(
    "GET", 
    "map_data?ne_lat=" + String(ne_lat) + 
    "&ne_lng=" + String(ne_lng) +
    "&sw_lat=" + String(sw_lat) +
    "&sw_lng=" + String(sw_lng),
    true);
  xmlhttp.send();
}

function on_bounds_changed(){
  
  ne_lat_1 = map.getBounds().getNorthEast().lat(),
  ne_lng_1 = map.getBounds().getNorthEast().lng(),
  sw_lat_1 = map.getBounds().getSouthWest().lat(),
  sw_lng_1= map.getBounds().getSouthWest().lng();
  
  span_lat_1 = ne_lat_1 - sw_lat_1;
  span_lng_1 = ne_lng_1 - sw_lng_1;
  span_lat = ne_lat - sw_lat;
  span_lng = ne_lng - sw_lng;  
  
  // Only reload the data if the view changes a lot
  if(
    ne_lat_1 > ne_lat || 
    ne_lng_1 > ne_lng || 
    sw_lat_1 < sw_lat ||
    sw_lng_1 < sw_lng ||
    span_lat_1 < 0.20 * span_lat||
    span_lng_1 < 0.20 * span_lng
    )
  {
    
    ne_lat = ne_lat_1 + span_lat_1;
    sw_lat = sw_lat_1 - span_lat_1;
      
    ne_lng = ne_lng_1 + span_lng_1;
    sw_lng = sw_lng_1 - span_lng_1;
    request_data();  
  }
}

function initialize() {
  var mapCanvas = document.getElementById('map-canvas');
  var mapOptions = {
    center: new google.maps.LatLng(42.37, -71.12),
    zoom: 8,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  }
  map = new google.maps.Map(mapCanvas, mapOptions);
  google.maps.event.addListener(map, 'bounds_changed', on_bounds_changed);
  
}

google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
<body>

<h1>My First Heading</h1>

<p>My first paragraph.</p>
<div id = c1> </div>
<div id = c2> </div>
<div id="map-canvas" style="width:50em;height:40em;"></div>
</body>
</html>
