{% load staticfiles %}
<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="{% static 'explorer/main.css' %}" />
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script>

var map;
var geojsonData;
var ne_lat = 0.0, ne_lng = 0.0, sw_lat = 0.0, sw_lng = 0.0;
var infowindow;
var selected_provider = 0;
var selected_procedure = "all";
var descriptor_search_string = "";

function fill_in_descriptor_selector(jsonData){
  var descriptors = jsonData['descriptors'];
  var selector = document.getElementById('descriptor_selector');
  while (selector.firstChild) {
    selector.removeChild(selector.firstChild);
  }
  
 option = document.createElement('option');
 selector.appendChild(option);
 option.setAttribute("value", "all");
 option.text = "All";
    
  for(i = 0; i < descriptors.length; i++){
    option = document.createElement('option');
    selector.appendChild(option);
    option.setAttribute("value", descriptors[i][0]);
    option.text = descriptors[i][0] + ": " + descriptors[i][1]
  }
}

function on_server_response(xmlhttp){
  if (xmlhttp.readyState==4 && xmlhttp.status==200) {
    jsonData = JSON.parse(xmlhttp.responseText);
    if(jsonData['type'] == 'FeatureCollection') {
      map.data.forEach(function(feature){map.data.remove(feature);});
      map.data.addGeoJson(jsonData);
    }
    else if(jsonData['type'] = 'DescriptorList'){
      fill_in_descriptor_selector(jsonData);
    }
  }
}

function request_map_data(){
  if (window.XMLHttpRequest) {
    // code for IE7+, Firefox, Chrome, Opera, Safari
    xmlhttp=new XMLHttpRequest();
  } else {  // code for IE6, IE5
    xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
  }
  xmlhttp.onreadystatechange=function() {on_server_response(xmlhttp);};
  xmlhttp.open(
    "GET", 
    "map_data?ne_lat=" + String(ne_lat) + 
    "&ne_lng=" + String(ne_lng) +
    "&sw_lat=" + String(sw_lat) +
    "&sw_lng=" + String(sw_lng) +
    "&proc_code=" + selected_procedure,
    true);
  xmlhttp.send();
}

function request_descriptor_list(){
  
  str = descriptor_search_string;
  if (window.XMLHttpRequest) {
    // code for IE7+, Firefox, Chrome, Opera, Safari
    xmlhttp=new XMLHttpRequest();
  } else {  // code for IE6, IE5
    xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
  }
  xmlhttp.onreadystatechange=function() {on_server_response(xmlhttp);};
  xmlhttp.open(
    "GET", 
    "descriptor_list?npi=" + String(selected_provider) +
    "&str=" + str,
    true);
  xmlhttp.send();
}


function on_bounds_changed(){
  
  ne_lat_1 = map.getBounds().getNorthEast().lat(),
  ne_lng_1 = map.getBounds().getNorthEast().lng(),
  sw_lat_1 = map.getBounds().getSouthWest().lat(),
  sw_lng_1= map.getBounds().getSouthWest().lng();
  
  span_lat_1 = ne_lat_1 - sw_lat_1;
  span_lng_1 = ne_lng_1 - sw_lng_1;
  span_lat = ne_lat - sw_lat;
  span_lng = ne_lng - sw_lng;  
  
  // Only reload the data if the view changes a lot
  if(
    ne_lat_1 > ne_lat || 
    ne_lng_1 > ne_lng || 
    sw_lat_1 < sw_lat ||
    sw_lng_1 < sw_lng ||
    span_lat_1 < 0.20 * span_lat||
    span_lng_1 < 0.20 * span_lng
    )
  {
    
    ne_lat = ne_lat_1 + span_lat_1;
    sw_lat = sw_lat_1 - span_lat_1;
      
    ne_lng = ne_lng_1 + span_lng_1;
    sw_lng = sw_lng_1 - span_lng_1;
    request_map_data();  
  }
}

function initialize() {
  var mapCanvas = document.getElementById('map-canvas');
  var mapOptions = {
    center: new google.maps.LatLng({{Lat}},{{Lng}}),
    zoom: 14,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  }
  map = new google.maps.Map(mapCanvas, mapOptions);
  infowindow = new google.maps.InfoWindow();
  
//   map.data.setStyle(function(feature) {
//     var radius = 5 * feature.getProperty('expensiveness');
//     if(radius > 30){
//       radius = 30
//     }
//     
//     return {
//       icon: {
//         path: google.maps.SymbolPath.CIRCLE,
//         strokeWeight: 1,
//         fillOpacity: .5,
//         fillColor: '#CC0066',
//         strokeColor: '#660033',
//         scale: radius
//       }
//     };
//   });
  
  google.maps.event.addListener(map, 'bounds_changed', on_bounds_changed);
  map.data.addListener('mouseover', function(event) {
    infowindow.setContent(
      event.feature.getProperty('first_name') + " " + 
      event.feature.getProperty('last_name') + "<br/>" +
      event.feature.getProperty('npi'));
    infowindow.setPosition(event.latLng);
    infowindow.setOptions({pixelOffset: new google.maps.Size(0,-34)});
    infowindow.open(map);
  });
  
  map.data.addListener('click', function(event) {
    selected_provider = event.feature.getProperty('npi');
    request_descriptor_list();
  });
  
}

function on_descriptor_selector_change(selector){
  var i = selector.selectedIndex;
  var code = selector.options[i].value;
  selected_procedure = code;
  request_map_data();
}

function on_descriptor_search_keyup(str){
 descriptor_search_string = str;
 request_descriptor_list();
}

google.maps.event.addDomListener(window, 'load', initialize);
request_descriptor_list();

    </script>
  </head>
<body>

  <h1>Medissect</h1>
  <div id = "dump"></div>
  
  <table>
    <tr>
      <td>
        <div id="map-canvas" style="width:35em;height:20em;"></div>
      </td>
      <td>
        <input id="descriptor_search" type="text" onkeyup="on_descriptor_search_keyup(this.value)"> <br/>
        <select id="descriptor_selector" size="20" onchange= "on_descriptor_selector_change(this)">
        </select>
      </td>
    </tr>
  </table>

</body>
</html>
